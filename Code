# Portefeuille de Markowitz
# Anthony Vallée — François Damiani
# TD 5

# Import des librairies
import yfinance as yf
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from scipy.optimize import minimize


# Fonctions

def choose_assets():
    # Choix des actions
    assets=[]
    auto=input("Sélection automatique ? (oui/non) : ").strip().lower()

    if auto=="oui":
        assets=["AAPL","GOOGL","META","XOM","PG","NVDA"]
    else:
        n=int(input("Nombre d'actions : "))
        for i in range(n):
            ticker=input("Action (ex : AAPL, MSFT, AMZN, GOOGL, META, XOM, PG, NVDA) : ").strip().upper()
            assets.append(ticker)

    return assets


def set_weights(assets):
    # Pondérations manuelles
    total=0
    while total!=100:
        weights=[]
        total=0
        print("\nLa somme doit être égale à 100 %\n")

        for t in assets:
            w=float(input(f"{t} : ").replace(",","."))
            weights.append(w)
            total=sum(weights)
            print(f"Total actuel : {total} %")

        if total!=100:
            print("Erreur de pondération\n")

    return np.array(weights)/100


def optimize_weights(mean_ret,cov_mat,rf=0.03,method="sharpe",target_ret=None,long_only=True):
    # Optimisation Markowitz
    n=len(mean_ret)
    mean_ret=np.asarray(mean_ret)
    cov_mat=np.asarray(cov_mat)

    def port_ret(w):
        return float(w@mean_ret)

    def port_var(w):
        return float(w.T@cov_mat@w)

    def port_vol(w):
        return np.sqrt(port_var(w))

    if method=="sharpe":
        def obj(w):
            return -(port_ret(w)-rf)/port_vol(w)
    elif method=="min_var":
        def obj(w):
            return port_var(w)
    elif method=="target":
        def obj(w):
            return port_var(w)
    else:
        raise ValueError("Méthode invalide")

    constraints=[{"type":"eq","fun":lambda w:np.sum(w)-1}]

    if method=="target":
        constraints.append({"type":"eq","fun":lambda w:port_ret(w)-target_ret})

    bounds=[(0,1)]*n if long_only else [(-1,1)]*n
    w0=np.ones(n)/n

    res=minimize(obj,w0,method="SLSQP",bounds=bounds,constraints=constraints)

    if not res.success:
        raise RuntimeError("Optimisation échouée")

    w=res.x
    w[np.abs(w)<1e-8]=0
    return w/np.sum(w)


# Programme principal

assets=choose_assets()

# Prix historiques
prices=yf.download(assets,start="2019-01-01",auto_adjust=True,progress=False)["Close"]

# Rendements log journaliers
returns_daily=np.log(prices/prices.shift(1)).dropna()

# Jours de cotation 2025
prices_25=yf.download(assets,start="2025-01-01",end="2026-01-01",auto_adjust=True,progress=False)["Close"]
n_days=len(prices_25.dropna())

# Moyennes et covariance
mean_daily=returns_daily.mean()
cov_daily=returns_daily.cov()

# Annualisation
mean_annual=mean_daily*n_days
cov_annual=cov_daily*n_days

# Choix des pondérations
mode=input("\nManuel ou optimisation ? (manuel/opti) : ").strip().lower()

if mode=="opti":
    print("Méthodes : sharpe / min_var / target")
    method=input("Choix : ").strip().lower()
    rf=0.03

    if method=="target":
        target=float(input("Rendement cible (ex : 0.10) : ").replace(",","."))
        weights=optimize_weights(mean_annual,cov_annual,rf,method,target)
    else:
        weights=optimize_weights(mean_annual,cov_annual,rf,method)
else:
    weights=set_weights(assets)

# Performances
port_return=float(weights@mean_annual)
port_var=float(weights.T@cov_annual@weights)
port_vol=np.sqrt(port_var)
sharpe=(port_return-rf)/port_vol

print("\nRésultats")
print(f"Rendement annuel : {port_return:.2%}")
print(f"Volatilité : {port_vol:.2%}")
print(f"Sharpe : {sharpe:.2f}")

# Résumé
summary=pd.DataFrame({"actions":assets,"weight_%":np.round(weights*100,2),"return_%":np.round(mean_annual.values*100,2)})

print("\nPortefeuille")
print(summary.to_string(index=False))

# Valeur du portefeuille base 100
base=100
portfolio=(prices/prices.iloc[0]).mul(weights,axis=1).sum(axis=1)*base

plt.figure()
plt.plot(portfolio.index,portfolio.values)
plt.title("Évolution du portefeuille (base 100)")
plt.xlabel("Date")
plt.ylabel("Valeur")
plt.tight_layout()
plt.show()

# Exports
summary.to_csv("resume_portefeuille.csv",index=False)

plt.figure()
plt.plot(portfolio.index,portfolio.values)
plt.title("Évolution du portefeuille (base 100)")
plt.xlabel("Date")
plt.ylabel("Valeur")
plt.tight_layout()
plt.savefig("evolution_portefeuille.png",dpi=150)
plt.close()
